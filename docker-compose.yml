version: '3.8'

services:
  web:
    build: .
    command: >
      sh -c "python manage.py migrate &&
             python manage.py createsuperuser --noinput --username ${DJANGO_SUPERUSER_USERNAME} --email ${DJANGO_SUPERUSER_EMAIL} --password ${DJANGO_SUPERUSER_PASSWORD} || true &&
             gunicorn military_packing_list.wsgi:application --bind 0.0.0.0:8000"
    volumes:
      - .:/app
    ports:
      - "${WEB_APP_HOST_PORT:-8000}:8000" # Use .env variable with default
    environment:
      - SECRET_KEY=${SECRET_KEY:-your_very_secret_key_for_development_only_change_in_prod_later}
      - DEBUG=${DEBUG:-1}
      - DB_NAME=${DB_NAME:-packerdb}
      - DB_USER=${DB_USER:-packeruser}
      - DB_PASSWORD=${DB_PASSWORD:-packerpassword}
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-5432}
      - ALLOWED_HOSTS_PROD=${ALLOWED_HOSTS_PROD:-localhost,127.0.0.1,web} # Default for when DEBUG=0
      - DJANGO_SUPERUSER_USERNAME=${DJANGO_SUPERUSER_USERNAME:-admin}
      - DJANGO_SUPERUSER_PASSWORD=${DJANGO_SUPERUSER_PASSWORD:-adminpassword}
      - DJANGO_SUPERUSER_EMAIL=${DJANGO_SUPERUSER_EMAIL:-admin@example.com}
    depends_on:
      - db
    # env_file: .env # Docker Compose automatically looks for a file named .env in the project directory

  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_DB=${DB_NAME:-packerdb} # Use the same DB_NAME from .env or default
      - POSTGRES_USER=${DB_USER:-packeruser} # Use the same DB_USER
      - POSTGRES_PASSWORD=${DB_PASSWORD:-packerpassword} # Use the same DB_PASSWORD
    ports:
      - "${DB_HOST_PORT:-5432}:5432" # Use .env variable with default, if exposing

volumes:
  postgres_data:
