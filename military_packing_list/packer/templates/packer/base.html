{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Military Gear Pricer</title>
    <link rel="stylesheet" type="text/css" href="{% static 'packer/css/style.css' %}">
</head>
<body>
    <nav class="main-nav">
        <div class="nav-container"> <!-- For centering content within the nav bar -->
            <a href="{% url 'packer:item_list' %}" class="nav-brand">GearPricer</a>
            <ul>
                <li><a href="{% url 'packer:item_list' %}">Home</a></li>
                <li><a href="{% url 'packer:about' %}">About</a></li>
                <!-- Example: Link to admin for adding items if no frontend form exists yet -->
                {% if user.is_staff %} <!-- Show admin link only to staff users -->
                <li><a href="{% url 'admin:index' %}">Admin</a></li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <div class="container">
        <h1>{% block page_title %}Military Gear Pricer{% endblock %}</h1> <!-- Page specific title block -->
        {% block content %}
        {% endblock %}
    </div>

    <div style="display:none;">{% csrf_token %}</div>
    <script>
    // JS code for voting from previous implementation
    document.addEventListener('DOMContentLoaded', () => {
        const voteButtons = document.querySelectorAll('.vote-btn');
        // Ensure CSRF token can be found. If the hidden div is the only source:
        const csrfTokenInput = document.querySelector('div[style="display:none;"] input[name="csrfmiddlewaretoken"]');
        const getCsrfToken = () => csrfTokenInput ? csrfTokenInput.value : '';

        voteButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const priceId = button.dataset.priceId;
                const voteType = button.dataset.voteType;
                const url = `/packer/price/${priceId}/vote/${voteType}/`;
                const token = getCsrfToken();

                if (!token) {
                    console.error('CSRF token not found.');
                    alert('Error: CSRF token not found. Please refresh the page.');
                    return;
                }

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': token
                        },
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: response.statusText })); // Try to parse JSON, fallback to statusText
                        console.error('Vote failed server-side:', errorData.message || response.statusText);
                        alert('Vote failed: ' + (errorData.message || 'Server error. Please try again.'));
                        return;
                    }
                    const data = await response.json();
                    if (data.status === 'success') {
                        document.getElementById(`upvotes-${priceId}`).textContent = data.upvotes;
                        document.getElementById(`downvotes-${priceId}`).textContent = data.downvotes;
                    } else {
                        console.error('Vote failed:', data.message);
                        alert('Vote failed: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error submitting vote:', error);
                    alert('Error submitting vote: ' + error.message);
                }
            });
        });
    });
    </script>
</body>
</html>
