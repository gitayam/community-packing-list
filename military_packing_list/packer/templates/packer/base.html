{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Military Gear Pricer</title>
    <link rel="stylesheet" type="text/css" href="{% static 'packer/css/style.css' %}">
</head>
<body>
    <nav>
        <a href="{% url 'packer:item_list' %}">All Items</a>
        <!-- Add other global navigation if any -->
    </nav>
    <div class="container">
        <h1 class="page-title">Military Gear Pricer</h1> <!-- Moved H1 inside container and gave it a class -->
        <hr> <!-- Moved HR inside container -->
        {% block content %}
        {% endblock %}
    </div>

    <div style="display:none;">{% csrf_token %}</div> {# For JS to access CSRF token #}

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const voteButtons = document.querySelectorAll('.vote-btn');
        // Function to get CSRF token from the hidden input field
        const getCsrfToken = () => {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            return csrfInput ? csrfInput.value : null;
        };

        voteButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const priceId = button.dataset.priceId;
                const voteType = button.dataset.voteType;
                const csrfToken = getCsrfToken();

                if (!csrfToken) {
                    console.error('CSRF token not found.');
                    alert('Could not process vote: CSRF token missing. Please reload the page.');
                    return;
                }

                // Construct the URL carefully based on your Django URL configuration
                // This assumes your app is mounted at /packer/
                const url = `/packer/price/${priceId}/vote/${voteType}/`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        // body: JSON.stringify({}) // No body needed if data is in URL parameters for this specific view
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: response.statusText })); // Try to parse JSON, fallback to statusText
                        console.error('Vote failed server-side:', errorData.message || response.statusText);
                        alert('Vote failed: ' + (errorData.message || 'Server error. Please try again.'));
                        return;
                    }

                    const data = await response.json();

                    if (data.status === 'success') {
                        const upvotesEl = document.getElementById(`upvotes-${priceId}`);
                        const downvotesEl = document.getElementById(`downvotes-${priceId}`);
                        if (upvotesEl) upvotesEl.textContent = data.upvotes;
                        if (downvotesEl) downvotesEl.textContent = data.downvotes;

                        // Optional: Update reputation score if you have a place to display it
                        // console.log("New reputation score:", data.reputation_score);
                    } else {
                        console.error('Vote submission failed:', data.message);
                        alert('Vote submission failed: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error submitting vote (network or JS error):', error);
                    alert('Error submitting vote: ' + error.message);
                }
            });
        });
    });
    </script>
</body>
</html>
