(()=>{"use strict";class e{modal=null;addStoreDiv=null;storeSelect=null;storeNameInput=null;priceInput=null;quantityInput=null;confidenceSelect=null;pricePerUnitDisplay=null;priceValidationMessage=null;submitButton=null;historicalPrices=[];currentItemId=null;currentListId=null;settings;constructor(){this.loadSettings(),this.initialize()}initialize(){this.setupElements(),this.setupEventListeners(),this.setupPriceCalculator(),this.setupKeyboardShortcuts(),this.setupMobileOptimizations(),this.createModal(),this.toggleAddStoreSection()}loadSettings(){const e=localStorage.getItem("priceFormSettings");this.settings=e?JSON.parse(e):{lastStore:"",recentPrices:[],autoFillConfidence:"medium"}}saveSettings(){localStorage.setItem("priceFormSettings",JSON.stringify(this.settings))}setupElements(){if(this.modal=document.getElementById("price-modal"),this.addStoreDiv=document.getElementById("inline-add-store"),this.storeSelect=document.getElementById("id_store"),this.storeNameInput=document.getElementById("id_store_name"),this.priceInput=document.getElementById("id_price"),this.quantityInput=document.getElementById("id_quantity"),this.confidenceSelect=document.getElementById("id_confidence"),this.submitButton=document.querySelector('#price-form button[type="submit"]'),this.priceInput&&!document.getElementById("price-per-unit-display")){const e=this.priceInput.parentElement;if(e){const t=document.createElement("div");t.id="price-per-unit-display",t.className="price-calculator mt-2",t.innerHTML='<small class="text-muted">Price per unit: <span id="price-per-unit-value">--</span></small>',e.appendChild(t),this.pricePerUnitDisplay=t}}if(this.priceInput&&!document.getElementById("price-validation-message")){const e=this.priceInput.parentElement;if(e){const t=document.createElement("div");t.id="price-validation-message",t.className="price-validation mt-1",e.appendChild(t),this.priceValidationMessage=t}}}createModal(){if(!this.modal&&(this.modal=document.createElement("div"),this.modal.id="price-modal",this.modal.className="modal-overlay",this.modal.innerHTML='\n      <div class="modal-content mobile-optimized">\n        <div class="modal-header">\n          <h3 id="modal-title">Add Price</h3>\n          <button type="button" class="modal-close" onclick="closePriceModal()">Ã—</button>\n        </div>\n        <div class="modal-body" id="price-modal-body">\n          \x3c!-- Form will be loaded here via AJAX --\x3e\n        </div>\n      </div>\n    ',document.body.appendChild(this.modal),!document.getElementById("price-modal-styles"))){const e=document.createElement("style");e.id="price-modal-styles",e.textContent="\n        .modal-overlay {\n          position: fixed;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          background: rgba(0, 0, 0, 0.5);\n          display: none;\n          z-index: 1000;\n          align-items: flex-start;\n          justify-content: center;\n          padding: 20px;\n          box-sizing: border-box;\n          overflow-y: auto;\n        }\n        \n        .modal-content {\n          background: white;\n          border-radius: 8px;\n          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n          width: 100%;\n          max-width: 500px;\n          max-height: 90vh;\n          overflow-y: auto;\n          margin-top: 5vh;\n        }\n        \n        .mobile-optimized {\n          position: relative;\n        }\n        \n        .modal-header {\n          padding: 16px 20px;\n          border-bottom: 1px solid #eee;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          position: sticky;\n          top: 0;\n          background: white;\n          z-index: 1;\n        }\n        \n        .modal-header h3 {\n          margin: 0;\n          font-size: 18px;\n        }\n        \n        .modal-close {\n          background: none;\n          border: none;\n          font-size: 24px;\n          cursor: pointer;\n          padding: 0;\n          width: 32px;\n          height: 32px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border-radius: 4px;\n        }\n        \n        .modal-close:hover {\n          background: #f5f5f5;\n        }\n        \n        .modal-body {\n          padding: 20px;\n        }\n        \n        .form-group {\n          margin-bottom: 16px;\n        }\n        \n        .form-group label {\n          display: block;\n          margin-bottom: 4px;\n          font-weight: 500;\n          font-size: 14px;\n        }\n        \n        .form-group input,\n        .form-group select,\n        .form-group textarea {\n          width: 100%;\n          padding: 12px;\n          border: 1px solid #ddd;\n          border-radius: 4px;\n          font-size: 16px;\n          box-sizing: border-box;\n        }\n        \n        .form-group input:focus,\n        .form-group select:focus {\n          outline: none;\n          border-color: #007bff;\n          box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);\n        }\n        \n        .quick-actions {\n          margin: 12px 0;\n        }\n        \n        .btn-group {\n          display: flex;\n          gap: 8px;\n          flex-wrap: wrap;\n        }\n        \n        .btn-group button {\n          flex: 1;\n          min-width: 60px;\n          padding: 8px 12px;\n          border: 1px solid #ddd;\n          background: white;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: all 0.2s;\n        }\n        \n        .btn-group button:hover {\n          background: #f8f9fa;\n          border-color: #007bff;\n        }\n        \n        .btn-group button:active {\n          background: #e9ecef;\n        }\n        \n        .form-actions {\n          margin-top: 24px;\n          display: flex;\n          gap: 12px;\n          justify-content: flex-end;\n          position: sticky;\n          bottom: 0;\n          background: white;\n          padding: 16px 0 0;\n          border-top: 1px solid #eee;\n        }\n        \n        .button {\n          padding: 12px 24px;\n          border: none;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 16px;\n          font-weight: 500;\n          min-width: 80px;\n          transition: all 0.2s;\n        }\n        \n        .button.success {\n          background: #28a745;\n          color: white;\n        }\n        \n        .button.success:hover {\n          background: #218838;\n        }\n        \n        .button.success:disabled {\n          background: #6c757d;\n          cursor: not-allowed;\n        }\n        \n        .button.secondary {\n          background: #6c757d;\n          color: white;\n        }\n        \n        .button.secondary:hover {\n          background: #5a6268;\n        }\n        \n        .price-calculator {\n          font-size: 14px;\n          color: #28a745;\n        }\n        \n        .price-validation {\n          font-size: 14px;\n        }\n        \n        .text-success { color: #28a745; }\n        .text-warning { color: #ffc107; }\n        .text-danger { color: #dc3545; }\n        .text-muted { color: #6c757d; }\n        \n        .keyboard-hints {\n          margin-top: 8px;\n          text-align: center;\n        }\n        \n        @media (max-width: 768px) {\n          .modal-overlay {\n            padding: 0;\n            align-items: flex-end;\n          }\n          \n          .modal-content {\n            max-width: 100%;\n            margin-top: 0;\n            border-radius: 12px 12px 0 0;\n            max-height: 85vh;\n          }\n          \n          .modal-header {\n            padding: 12px 16px;\n          }\n          \n          .modal-body {\n            padding: 16px;\n          }\n          \n          .form-group input,\n          .form-group select {\n            font-size: 16px;\n            padding: 14px 12px;\n          }\n          \n          .btn-group {\n            gap: 6px;\n          }\n          \n          .btn-group button {\n            padding: 10px 8px;\n            font-size: 13px;\n          }\n          \n          .form-actions {\n            padding: 12px 0 0;\n          }\n          \n          .button {\n            padding: 14px 20px;\n            font-size: 16px;\n          }\n        }\n      ",document.head.appendChild(e)}}setupEventListeners(){this.storeSelect&&this.addStoreDiv&&this.storeSelect.addEventListener("change",this.onStoreChange.bind(this)),this.priceInput&&(this.priceInput.addEventListener("input",this.onPriceInput.bind(this)),this.priceInput.addEventListener("blur",this.validatePrice.bind(this))),this.quantityInput&&this.quantityInput.addEventListener("input",this.calculatePricePerUnit.bind(this));const e=document.getElementById("price-form");e&&e.addEventListener("submit",this.handleFormSubmit.bind(this)),this.modal&&this.modal.addEventListener("click",e=>{e.target===this.modal&&this.closeModal()})}setupMobileOptimizations(){document.querySelectorAll("input, select, textarea").forEach(e=>{(e instanceof HTMLInputElement||e instanceof HTMLSelectElement)&&(""===e.style.fontSize||parseFloat(getComputedStyle(e).fontSize)<16)&&(e.style.fontSize="16px")}),document.addEventListener("touchstart",()=>{},{passive:!0})}setupPriceCalculator(){window.calculatePricePerUnit=this.calculatePricePerUnit.bind(this),window.setQuickPrice=this.setQuickPrice.bind(this),window.openPriceModal=this.openModal.bind(this),window.closePriceModal=this.closeModal.bind(this)}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&"Enter"===e.key){const e=document.getElementById("price-form");e&&e.submit()}if("Escape"===e.key){const e=document.getElementById("price-modal");e&&(e.style.display="none")}})}onPriceInput(){this.calculatePricePerUnit(),this.clearValidationMessage()}calculatePricePerUnit(){if(!this.priceInput||!this.quantityInput)return;const e=parseFloat(this.priceInput.value),t=parseInt(this.quantityInput.value),n=document.getElementById("price-per-unit-value");if(n)if(e>0&&t>0){const i=(e/t).toFixed(2);n.textContent=`$${i}`,n.className="text-success"}else n.textContent="--",n.className="text-muted"}validatePrice(){if(!this.priceInput||!this.priceValidationMessage)return;const e=parseFloat(this.priceInput.value);if(isNaN(e)||e<=0)this.showValidationMessage("Please enter a valid price greater than zero.","error");else if(e>1e4)this.showValidationMessage("This price seems unusually high. Please verify the amount.","warning");else if(e<.01)this.showValidationMessage("Price must be at least $0.01.","error");else if(this.historicalPrices.length>0){const t=this.historicalPrices.reduce((e,t)=>e+t.price,0)/this.historicalPrices.length;e>3*t?this.showValidationMessage(`This price is significantly higher than the average ($${t.toFixed(2)}). Please verify.`,"warning"):e<.3*t?this.showValidationMessage(`This price is significantly lower than the average ($${t.toFixed(2)}). Please verify.`,"warning"):this.showValidationMessage("Price looks reasonable based on historical data.","success")}}showValidationMessage(e,t){this.priceValidationMessage&&(this.priceValidationMessage.innerHTML=`\n      <small class="text-${"success"===t?"success":"warning"===t?"warning":"danger"}">\n        ${e}\n      </small>\n    `)}clearValidationMessage(){this.priceValidationMessage&&(this.priceValidationMessage.innerHTML="")}toggleAddStoreSection(){this.storeSelect&&this.addStoreDiv&&("__add_new__"===this.storeSelect.value?(this.addStoreDiv.style.display="block",this.storeNameInput&&(this.storeNameInput.required=!0,this.storeNameInput.focus())):(this.addStoreDiv.style.display="none",this.storeNameInput&&(this.storeNameInput.required=!1,this.storeNameInput.value="")))}setHistoricalPrices(e){this.historicalPrices=e}setQuickPrice(e){this.priceInput&&(this.priceInput.value=e.toFixed(2),this.priceInput.focus(),this.calculatePricePerUnit(),this.validatePrice())}onStoreChange(){this.toggleAddStoreSection(),this.storeSelect&&this.storeSelect.value&&"__add_new__"!==this.storeSelect.value&&(this.settings.lastStore=this.storeSelect.value,this.saveSettings())}async openModal(e,t,n){this.currentItemId=e,this.currentListId=t||null,this.modal||this.createModal();try{const n=t?`/item/${e}/add_price_modal/to_list/${t}/`:`/item/${e}/add_price_modal/`,i=await fetch(n,{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!i.ok)throw new Error("Failed to load price form");const s=await i.text(),o=this.modal.querySelector("#price-modal-body");o&&(o.innerHTML=s),this.setupElements(),this.setupEventListeners(),this.settings.lastStore&&this.storeSelect&&this.storeSelect.querySelector(`option[value="${this.settings.lastStore}"]`)&&(this.storeSelect.value=this.settings.lastStore),this.confidenceSelect&&(this.confidenceSelect.value=this.settings.autoFillConfidence),this.modal.style.display="flex",setTimeout(()=>{this.priceInput&&this.priceInput.focus()},100)}catch(e){console.error("Error opening price modal:",e),alert("Failed to load price form. Please try again.")}}closeModal(){this.modal&&(this.modal.style.display="none")}async handleFormSubmit(e){if(e.preventDefault(),!this.submitButton)return;const t=e.target,n=new FormData(t);this.submitButton.disabled=!0,this.submitButton.textContent="Saving...";try{const e=await fetch(t.action,{method:"POST",body:n,headers:{"X-Requested-With":"XMLHttpRequest"}});if(e.ok){if(this.storeSelect&&this.storeSelect.value&&"__add_new__"!==this.storeSelect.value&&(this.settings.lastStore=this.storeSelect.value),this.confidenceSelect&&(this.settings.autoFillConfidence=this.confidenceSelect.value),this.priceInput&&this.priceInput.value){const e=parseFloat(this.priceInput.value);e>0&&(this.settings.recentPrices.unshift(e),this.settings.recentPrices=this.settings.recentPrices.slice(0,5))}this.saveSettings(),this.closeModal(),this.showToast("Price added successfully!","success"),window.location.reload()}else{const t=await e.text(),n=this.modal.querySelector("#price-modal-body");n&&(n.innerHTML=t,this.setupElements(),this.setupEventListeners())}}catch(e){console.error("Error submitting form:",e),this.showToast("Failed to save price. Please try again.","error")}finally{this.submitButton&&(this.submitButton.disabled=!1,this.submitButton.textContent="Save Price")}}showToast(e,t){const n=document.createElement("div");n.className=`toast toast-${t}`,n.textContent=e,n.style.cssText=`\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 12px 24px;\n      border-radius: 4px;\n      color: white;\n      font-weight: 500;\n      z-index: 10000;\n      transform: translateX(100%);\n      transition: transform 0.3s ease;\n      ${"success"===t?"background: #28a745;":"background: #dc3545;"}\n    `,document.body.appendChild(n),setTimeout(()=>{n.style.transform="translateX(0)"},10),setTimeout(()=>{n.style.transform="translateX(100%)",setTimeout(()=>{document.body.removeChild(n)},300)},3e3)}}function t(){new e}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()})();
//# sourceMappingURL=price-form-modal.js.map