{% extends "packing_lists/base.html" %}
{% load static %}

{% block title %}{{ title }} - Community Packing Lists{% endblock %}

{% block page_header %}{{ title }}{% endblock %}

{% block content %}
    <div class="filter-form mb-8">
        <form method="get" action="{% url 'store_list' %}">
            <div>
                <label for="city">City:</label>
                <input type="text" name="city" id="city" value="{{ current_filters.city }}">
            </div>
            <div>
                <label for="state">State:</label>
                <input type="text" name="state" id="state" value="{{ current_filters.state }}">
            </div>
            <div>
                <label for="zip_code">Zip Code:</label>
                <input type="text" name="zip_code" id="zip_code" value="{{ current_filters.zip_code }}">
            </div>
            <hr class="my-2">
            <div>
                <label for="school_id">Near Base/School:</label>
                <select name="school_id" id="school_id">
                    <option value="">-- Select a Base/School --</option>
                    {% for school in schools %}
                        <option value="{{ school.id }}" {% if current_filters.school_id == school.id|stringformat:"s" %}selected{% endif %}>
                            {{ school.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <hr class="my-2">
            <div class="actions-row">
                <button type="submit" class="btn btn--primary">Apply Filters</button>
                <button type="button" id="find-near-me" class="btn btn--secondary gps-button">Find Stores Near Me (GPS)</button>
                <a href="{% url 'store_list' %}" class="btn btn--secondary">Clear Filters</a>
            </div>
            <input type="hidden" name="user_lat" id="user_lat" value="{{ current_filters.user_lat }}">
            <input type="hidden" name="user_lon" id="user_lon" value="{{ current_filters.user_lon }}">
        </form>
    </div>

    <h2>{{ filter_description }}</h2>
    <div class="centered-action">
      <button id="add-store-btn" class="btn btn--secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Add Store
      </button>
    </div>
    <div id="store-modal" class="modal" style="display:none;">
      <div id="store-modal-content" class="modal-content">
        <button id="close-store-modal" class="modal-close" aria-label="Close">&times;</button>
        <div id="store-modal-body">
          <!-- AJAX-loaded form will go here -->
        </div>
      </div>
    </div>
    {% if stores %}
        <ul class="store-list">
            {% for item_data in stores %}
                <li class="store-item">
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <h2 class="store-name">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shopping-bag icon-inline" aria-hidden="true"><path d="M6 2l1.5 3h9L18 2"></path><path d="M3 7h18l-1 12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2L3 7z"></path><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                              {{ item_data.store.name }}
                            </h2>
                            <p class="item-notes mb-1">{{ item_data.store.formatted_address }}</p>
                            {% if item_data.store.url %}
                                <p><a href="{{ item_data.store.url }}" target="_blank">Website</a></p>
                            {% endif %}
                            {% if item_data.store.address_line1 and item_data.store.city and item_data.store.state %}
                                {% if item_data.store.google_maps_link %}
                                    <p><a href="{{ item_data.store.google_maps_link }}" target="_blank">Google Maps</a> | <a href="{{ item_data.store.apple_maps_link }}" target="_blank">Apple Maps</a></p>
                                {% endif %}
                            {% endif %}
                            <div class="mt-2">
                                {% if item_data.store.is_online and item_data.store.is_in_person %}
                                    <span class="badge badge--info">Online</span>
                                    <span class="badge badge--success">In Person</span>
                                {% elif item_data.store.is_online %}
                                    <span class="badge badge--info">Online</span>
                                {% elif item_data.store.is_in_person %}
                                    <span class="badge badge--success">In Person</span>
                                {% endif %}
                                {% if item_data.distance is not None %}
                                    <span class="badge badge--warning">{{ item_data.distance|floatformat:2 }} km</span>
                                {% endif %}
                            </div>
                            {% if item_data.store.latitude and item_data.store.longitude %}
                                <p class="text-small text-muted">Lat: {{ item_data.store.latitude|floatformat:4 }}, Lon: {{ item_data.store.longitude|floatformat:4 }}</p>
                            {% endif %}
                        </div>
                        <a href="{% url 'edit_store' item_data.store.id %}" class="btn btn--secondary btn--sm">Edit</a>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="no-stores">No stores found matching your criteria.</p>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'packing_lists/js/shared.js' %}"></script>
<script src="{% static 'packing_lists/js/store-list.js' %}"></script>
{% endblock %}
