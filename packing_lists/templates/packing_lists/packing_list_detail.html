{% extends "packing_lists/base.html" %}

{% block title %}{{ packing_list.name }} - Packing List{% endblock %}

{% block page_header %}{{ packing_list.name }}{% endblock %}

{% block content %}
    <div class="list-meta">
        {% if packing_list.school %}
            <p><strong>School:</strong> {{ packing_list.school.name }}</p>
        {% endif %}
        {% if packing_list.description %}
            <p><em>{{ packing_list.description }}</em></p>
        {% endif %}
    </div>

    <div class="actions-bar">
        {# <a href="{% url 'edit_packing_list' packing_list.id %}" class="button secondary">Edit List Details</a> #}
        <a href="{% url 'add_item_to_list' packing_list.id %}" class="button success">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add New Item
        </a>
    </div>

    <div class="table-controls">
        <div class="table-controls-left">
            <input type="text" id="item-table-filter" class="table-filter-input" placeholder="🔍 Search items...">
        </div>
        <div class="table-controls-right">
            <button type="button" id="toggle-columns" class="button secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-columns"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="9" y2="15"></line><line x1="15" y1="9" x2="15" y2="15"></line></svg>
                Show Details
            </button>
            <button type="button" id="clear-filters" class="button secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                Clear
            </button>
        </div>
    </div>

    <h2>Items</h2>
    {% if items_with_prices %}
        <form method="post" id="packing-list-items-form">
            {% csrf_token %}
            <div class="modern-table-wrapper">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="packed">
                                <span class="th-content">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-square"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                                    Packed
                                </span>
                            </th>
                            <th class="sortable" data-sort="name">
                                <span class="th-content">Item Name</span>
                            </th>
                            <th class="sortable" data-sort="quantity">
                                <span class="th-content">Qty</span>
                            </th>
                            <th class="sortable" data-sort="required">
                                <span class="th-content">Required</span>
                            </th>
                            <th class="sortable" data-sort="store">
                                <span class="th-content">Best Store</span>
                            </th>
                            <th class="sortable" data-sort="price">
                                <span class="th-content">Price</span>
                            </th>
                            <th class="actions-column">
                                <span class="th-content">Actions</span>
                            </th>
                            <!-- Hidden columns -->
                            <th class="hidden-column sortable" data-sort="section">
                                <span class="th-content">Section</span>
                            </th>
                            <th class="hidden-column sortable" data-sort="nsn">
                                <span class="th-content">NSN/LIN</span>
                            </th>
                            <th class="hidden-column">
                                <span class="th-content">Notes</span>
                            </th>
                            <th class="hidden-column">
                                <span class="th-content">Instructions</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% regroup items_with_prices by pli.section as sectioned_items %}
                        {% for section in sectioned_items %}
                            {% if section.grouper %}
                            <tr class="section-header-row">
                                <td colspan="7" class="section-header-cell">
                                    <strong>{{ section.grouper }}</strong>
                                </td>
                                <td colspan="4" class="section-header-cell hidden-column">
                                    <strong>{{ section.grouper }}</strong>
                                </td>
                            </tr>
                            {% endif %}
                            {% for item_wp in section.list %}
                            <tr class="item-row {% if item_wp.pli.packed %}packed-row{% endif %}" data-item-name="{{ item_wp.item.name|lower }}">
                                <td class="packed-cell">
                                    <button type="submit" name="toggle_packed_item_id" value="{{ item_wp.pli.id }}" class="pack-button {% if item_wp.pli.packed %}packed{% else %}unpacked{% endif %}">
                                        {% if item_wp.pli.packed %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-circle"><circle cx="12" cy="12" r="10"></circle></svg>
                                        {% endif %}
                                    </button>
                                </td>
                                <td class="item-name-cell">
                                    <strong>{{ item_wp.item.name }}</strong>
                                </td>
                                <td class="quantity-cell">
                                    <span class="quantity-badge">{{ item_wp.pli.quantity }}</span>
                                </td>
                                <td class="required-cell">
                                    {% if item_wp.pli.required %}
                                        <span class="status-badge required">Required</span>
                                    {% else %}
                                        <span class="status-badge optional">Optional</span>
                                    {% endif %}
                                </td>
                                <td class="store-cell">
                                    {% if item_wp.prices_with_votes and item_wp.prices_with_votes.0.price.store %}
                                        <div class="store-info">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-award"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 17 17 23 15.79 13.88"></polyline></svg>
                                            {{ item_wp.prices_with_votes.0.price.store.name }}
                                        </div>
                                    {% else %}
                                        <span class="no-store">No store data</span>
                                    {% endif %}
                                </td>
                                <td class="price-cell">
                                    {% if item_wp.prices_with_votes %}
                                        <div class="price-display">
                                            <span class="best-price">${{ item_wp.prices_with_votes.0.price.price }}</span>
                                            <button type="button" class="price-details-btn" data-item-id="{{ item_wp.item.id }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6"></path></svg>
                                            </button>
                                        </div>
                                        <div class="price-details" id="price-details-{{ item_wp.item.id }}" style="display: none;">
                                            {% for price_data in item_wp.prices_with_votes %}
                                                <div class="price-entry {% if forloop.first %}best-value{% endif %}">
                                                    <div class="price-main">
                                                        <strong>${{ price_data.price.price }}</strong> for {{ price_data.price.quantity }} 
                                                        at {{ price_data.price.store.name }}
                                                    </div>
                                                    <div class="price-meta">
                                                        ${{ price_data.price_per_unit|floatformat:2 }}/unit
                                                        {% if price_data.price.date_purchased %}• {{ price_data.price.date_purchased|date:"M d, Y" }}{% endif %}
                                                    </div>
                                                    <div class="price-actions">
                                                        <button type="button" class="vote-btn upvote" data-price-id="{{ price_data.price.id }}">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-thumbs-up"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                                                            {{ price_data.upvotes }}
                                                        </button>
                                                        <button type="button" class="vote-btn downvote" data-price-id="{{ price_data.price.id }}">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-thumbs-down"><path d="M10 15v7a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"></path></svg>
                                                            {{ price_data.downvotes }}
                                                        </button>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="no-price">No pricing</span>
                                    {% endif %}
                                </td>
                                <td class="actions-cell">
                                    <div class="action-buttons">
                                        <button type="button" class="action-btn add-price-btn" data-item-id="{{ item_wp.item.id }}" data-list-id="{{ packing_list.id }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-dollar-sign"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                                        </button>
                                        <a href="{% url 'edit_item_in_list' packing_list.id item_wp.pli.id %}" class="action-btn edit-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                        </a>
                                    </div>
                                </td>
                                <!-- Hidden columns -->
                                <td class="hidden-column section-cell">
                                    {{ item_wp.pli.section|default:"-" }}
                                </td>
                                <td class="hidden-column nsn-cell">
                                    {{ item_wp.pli.nsn_lin|default:"-" }}
                                </td>
                                <td class="hidden-column notes-cell">
                                    {{ item_wp.pli.notes|default:"-" }}
                                </td>
                                <td class="hidden-column instructions-cell">
                                    {{ item_wp.pli.instructions|default:"-" }}
                                </td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    {% else %}
        <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-package"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            <h3>No items in this packing list</h3>
            <p>Get started by adding your first item.</p>
            <a href="{% url 'add_item_to_list' packing_list.id %}" class="button success">Add First Item</a>
        </div>
    {% endif %}

    <!-- Price Modal -->
    <div id="price-modal" class="modal">
        <div id="price-modal-content" class="modal-content">
            <button id="close-price-modal" class="modal-close">&times;</button>
            <div id="price-modal-body">
                <!-- AJAX-loaded form will go here -->
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Table filtering
        const filterInput = document.getElementById('item-table-filter');
        const table = document.querySelector('.modern-table');
        const rows = table.querySelectorAll('tbody tr.item-row');
        
        filterInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            rows.forEach(row => {
                const itemName = row.dataset.itemName;
                const visible = itemName.includes(searchTerm);
                row.style.display = visible ? '' : 'none';
            });
        });
        
        // Clear filters
        document.getElementById('clear-filters').addEventListener('click', function() {
            filterInput.value = '';
            rows.forEach(row => row.style.display = '');
        });
        
        // Column toggle
        const toggleBtn = document.getElementById('toggle-columns');
        const tableWrapper = document.querySelector('.modern-table-wrapper');
        let columnsVisible = false;
        
        toggleBtn.addEventListener('click', function() {
            columnsVisible = !columnsVisible;
            
            if (columnsVisible) {
                tableWrapper.classList.add('show-hidden-columns');
                this.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                    Hide Details
                `;
            } else {
                tableWrapper.classList.remove('show-hidden-columns');
                this.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-columns"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="9" y2="15"></line><line x1="15" y1="9" x2="15" y2="15"></line></svg>
                    Show Details
                `;
            }
        });
        
        // Table sorting
        const sortableHeaders = document.querySelectorAll('.modern-table th.sortable');
        
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortType = this.dataset.sort;
                const currentSort = this.classList.contains('sort-asc') ? 'asc' : 
                                  this.classList.contains('sort-desc') ? 'desc' : 'none';
                
                // Remove sort classes from all headers
                sortableHeaders.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                
                // Add appropriate sort class
                if (currentSort === 'none' || currentSort === 'desc') {
                    this.classList.add('sort-asc');
                    sortTable(sortType, 'asc');
                } else {
                    this.classList.add('sort-desc');
                    sortTable(sortType, 'desc');
                }
            });
        });
        
        function sortTable(sortType, direction) {
            const tbody = table.querySelector('tbody');
            const allRows = Array.from(tbody.querySelectorAll('tr'));
            
            // Separate section headers and item rows
            const sectionHeaders = allRows.filter(row => row.classList.contains('section-header-row'));
            const itemRows = allRows.filter(row => row.classList.contains('item-row'));
            
            // Sort item rows
            itemRows.sort((a, b) => {
                let aVal, bVal;
                
                switch(sortType) {
                    case 'name':
                        aVal = a.querySelector('.item-name-cell').textContent.trim().toLowerCase();
                        bVal = b.querySelector('.item-name-cell').textContent.trim().toLowerCase();
                        break;
                    case 'quantity':
                        aVal = parseInt(a.querySelector('.quantity-badge').textContent);
                        bVal = parseInt(b.querySelector('.quantity-badge').textContent);
                        break;
                    case 'required':
                        aVal = a.querySelector('.status-badge').textContent.includes('Required') ? 1 : 0;
                        bVal = b.querySelector('.status-badge').textContent.includes('Required') ? 1 : 0;
                        break;
                    case 'packed':
                        aVal = a.classList.contains('packed-row') ? 1 : 0;
                        bVal = b.classList.contains('packed-row') ? 1 : 0;
                        break;
                    case 'price':
                        const aPriceEl = a.querySelector('.best-price');
                        const bPriceEl = b.querySelector('.best-price');
                        aVal = aPriceEl ? parseFloat(aPriceEl.textContent.replace('$', '')) : 0;
                        bVal = bPriceEl ? parseFloat(bPriceEl.textContent.replace('$', '')) : 0;
                        break;
                    default:
                        aVal = a.textContent.trim().toLowerCase();
                        bVal = b.textContent.trim().toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // Clear tbody and re-add sorted rows
            tbody.innerHTML = '';
            itemRows.forEach(row => tbody.appendChild(row));
        }
        
        // Price details toggle
        document.addEventListener('click', function(e) {
            if (e.target.closest('.price-details-btn')) {
                const btn = e.target.closest('.price-details-btn');
                const itemId = btn.dataset.itemId;
                const detailsDiv = document.getElementById(`price-details-${itemId}`);
                
                // Hide all other price details
                document.querySelectorAll('.price-details').forEach(div => {
                    if (div !== detailsDiv) {
                        div.style.display = 'none';
                    }
                });
                
                // Toggle current details
                if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
                    detailsDiv.style.display = 'block';
                    
                    // Position the details popup
                    const rect = btn.getBoundingClientRect();
                    detailsDiv.style.position = 'fixed';
                    detailsDiv.style.top = rect.bottom + 5 + 'px';
                    detailsDiv.style.left = Math.max(10, rect.left - 150) + 'px';
                    detailsDiv.style.zIndex = '1000';
                } else {
                    detailsDiv.style.display = 'none';
                }
            }
        });
        
        // Close price details when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.price-details') && !e.target.closest('.price-details-btn')) {
                document.querySelectorAll('.price-details').forEach(div => {
                    div.style.display = 'none';
                });
            }
        });
        
        // Add price modal functionality
        document.addEventListener('click', function(e) {
            if (e.target.closest('.add-price-btn')) {
                const btn = e.target.closest('.add-price-btn');
                const itemId = btn.dataset.itemId;
                const listId = btn.dataset.listId;
                
                // Open modal with add price form
                const modal = document.getElementById('price-modal');
                const modalBody = document.getElementById('price-modal-body');
                
                modalBody.innerHTML = `
                    <h3>Add Price Information</h3>
                    <form method="post" action="/packing-lists/${listId}/items/${itemId}/add-price/">
                        <div class="form-group">
                            <label for="price">Price ($):</label>
                            <input type="number" step="0.01" name="price" id="price" required>
                        </div>
                        <div class="form-group">
                            <label for="quantity">Quantity:</label>
                            <input type="number" name="quantity" id="quantity" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="store">Store:</label>
                            <select name="store" id="store" required>
                                <option value="">Select a store...</option>
                                <!-- This would be populated with available stores -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="date_purchased">Date Purchased:</label>
                            <input type="date" name="date_purchased" id="date_purchased">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="button success">Add Price</button>
                            <button type="button" class="button secondary" onclick="document.getElementById('price-modal').style.display='none'">Cancel</button>
                        </div>
                    </form>
                `;
                
                modal.style.display = 'flex';
            }
        });
        
        // Close modal functionality
        document.getElementById('close-price-modal').addEventListener('click', function() {
            document.getElementById('price-modal').style.display = 'none';
        });
        
        // Vote functionality (simplified)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.vote-btn')) {
                const btn = e.target.closest('.vote-btn');
                const priceId = btn.dataset.priceId;
                const isUpvote = btn.classList.contains('upvote');
                
                // This would normally make an AJAX call to handle the vote
                console.log(`${isUpvote ? 'Upvote' : 'Downvote'} for price ${priceId}`);
                
                // For now, just update the count visually
                const currentCount = parseInt(btn.textContent.match(/\d+/)[0]);
                btn.innerHTML = btn.innerHTML.replace(/\d+/, currentCount + 1);
            }
        });
    });
    </script>
{% endblock %}
